---
layout: post
title: 计时机器开发日志
date: 2017/12/10
categories: Android
tags: 保证维护
---

<a href="https://play.google.com/apps/testing/io.github.deweyreed.timer.google" target="_blank">Google Play Store的Beta测试链接</a> or <a href="https://www.coolapk.com/apk/177033" target="_blank">在酷安下载APK</a>

## 2018年5月29日

最近在写新的UI控件，这可费了事了。

## 2018年5月23日

重构基本完成了。等加点新功能在放出新版本吧，打算撸个好看点儿的UI。

## 2018年5月17日

这么久，先是重构应用，一半了去搞Google I/O 2018，完了接着重构并修复坏掉的功能。TODO攒了一大大大堆。

## 2018年5月6日

最近在重构整个应用，导致Bug攒了一大堆。。

## 2018年4月29日

移除了白名单指南，问题太多了，出了问题的发邮件吧，也不一定能解决。

已知两个问题，一是多个计时器运行时，点击通知打开的界面会混乱，二是编辑计时器时，旋转屏幕时数据会丢失。下下个版本修复。

还有就是决定不支持KitKat，需要太多的时间精力。

<!--more-->

## 2018年4月26日

增加了一个测试功能，不同设备的白名单指南。这几天先更一个小版本，就去重构应用了。

## 2018年4月24日

手痒又想重构了。重构==新功能暂时加不了，旧功能各种出问题+以后会爽到。

## 2018年4月19日

这几天有几个崩溃要解决，但这几天心力交瘁，就再加点其他功能过会儿更新吧。

## 2018年4月13日

2017年12月18日 那天的日志中提到的问题又重现了。应用被冻结，不是被杀，而是被执行暂停。只有在屏幕再次打开时，应用才会继续执行下一步。

这是一个跟国内厂商斗智斗勇的故事。计时器既然需要精确地计时，就要让CPU一直运行，这一点用WakeLock很容易解决。但这样阿猫阿狗都可以让CPU一直运行，不久流氓应用遍地了吗？于是各厂商就增加了应用冻结（或其他名字）的功能，如果应用让CPU一直运行，但又没有做什么实质性的工作，就会冻结它，不是杀了它，是暂停它。这样屏幕一打开，应用又可以继续工作了。

把应用添加到各个厂商手机中的白名单、保护应用、后台执行之类设置中，可以一定程度解决问题。至少我在测试中这么做，清空后台后，原本3分钟就被冻结的应用，现在3分钟、5分钟、10分钟也没问题了。

我在思考通过一些机制让应用正常工作。

## 2018年4月12日
本来打算今天发布0.2.0了，但决定给计时器执行实现加一些测试，过几天再发布吧。

## 2018年4月6日
重构数据层。下个版本可能要丢数据了。。。因为忘了给Model加Proguard。。

## 2018年4月4日
又要开始爆肝更新了。任务出奇的多啊，数据层也打算重构一下。Beta测试放飞自我，更新之后丢一些数据也是很正常的。

## 2018年4月3日
最近在充电，学各种东西，也在新功能开发各种库。

## 2018年3月24日
最近只修了一些Bug。重新搭了一下博客，研究了一会儿自动化脚本。。

## 2018年3月14日
岔出去几天写了个[剪贴板守护](https://github.com/DeweyReed/ClipboardCleaner)，算是为下一步的小工具、快捷方式的支持做准备了。

## 2018年3月12日
正在重构代码库。改一改就要跑一遍测试确保不会大崩坏。不过这Gradle Building + 测试可要了命了，跑一遍测试就等几分钟。。都能摸出鲸鱼了。

## 2018年3月9日
试着研究了一下悬浮窗。。奥利奥之前的API意外地简陋，这意味着工作比较复杂繁琐，慢慢来。

## 2018年3月8日
昨天发布了0.1.2。内容有步骤颜色、朗读步骤名称、电子表显示。接下来要清理一下代码库为下一步更多自定义功能做准备了。

似乎支持手环需要各个厂商的API，拿不到就支持不了了。

## 2018年3月3日
把朗读步骤名称做好了，也做了一些控件。文字转语音还是得用户自己想办法装一个能用的引擎并下载语音数据。

## 2018年2月25日
要加朗读步骤名称的行为了。在系统设置里配置好文字转语音（TextToSpeech，TTS）后，用起来还算方便，但国内各系统肯定各有各的阉割。

## 2018年2月23日
第二个Beta版本发布，解决了不知道计时器是否已经开始或结束的问题。接下来就要处理棘手的界面问题了。

## 2018年2月18日
现阶段主要在研究增强后的步骤选项，有点复杂，焦头烂额。

## 2018年2月14日
Beta阶段的任务就很多了。比如增强后的步骤选项（自定义的提醒步骤、只运行一次的启动和结束步骤）、更理想更多的计时器详细页面、朗读步骤名称。。。

最近刚刚重写了选取时间的控件。

## 2018年2月8日
可以进入Beta测试了。虽然有很多小细节可以改进，还有几个重要功能需要加入，但核心功能已经基本齐备了。

## 2018年2月7日
计时器流水线工作解决的差不多了，但发现计划任务在Android O上失效的问题，应该和最新的后台限制有关，暂时解决不了。Beta阶段试一试第三方Library。

## 2018年2月5日
发现现有的计时器的流水线工作存在一些小Bug，比如不停地暂停、+1分钟、前进、后退……就有可能把计数器玩儿坏。我得专门再次重构一下这块，年前发布不了不过年。

## 2018年2月4日
试着向下兼容KitKat，但会出现multiDex与lifecycle无法兼容导致崩溃的迷之Bug。或许在使用Proguard后可以继续在KitKat上使用，但Debug起来就很费事。找不到解决方案前可能无法支持Android 4.4了。

## 2018年2月2日
增加了夜间主题和介绍页。

## 2018年1月27日
0.0.5修复了无法正常保存的问题

## 2018年1月26日
想解决一个问题：在通知栏右侧显示一个类似于系统闹钟的小图标，提示未来有计划任务。研究了一下，那个小图标似乎是全系统的唯一且共享的。这意味着，如果手机上既有闹钟也有计划任务，两个就重叠了，只能看到一个，其实这也起不到原先的目的了。那就先不加入这个功能了，给系统让路。

## 2018年1月25日
1. 发现计划任务的重复设置可能有些Bug，一次性的似乎没问题。
2. 发布了0.0.4。更新有：临时为计时器增加一分钟；钦定的紫蓝主题色；增加帮助和相关页面；修复了计划任务的Bug。
3. 在加入一些小功能、跑一些测试、确保程序正常运行后，就可以进入Beta测试了。

## 2018年1月24日
增加了帮助与反馈。

在考虑需不需要增加一个单独的计时器启动和结束步骤。不然计时器启动或结束了都不知道。加入的话，需要加一个步骤还是多个步骤，是使用专门的Field保存，还是整合到已有的Steps中？

## 2018年1月22日
1. 在支持多主题（皮肤）的过程中遇到诸多困难，放弃了。可能会在加入夜间模式，但自定义颜色的设置可能要放在很久以后了。
2. 研究了一下其他应用的多主题原理。Todoist使用预定颜色，通过recreate() Activity实现。Telegram似乎是吧所有用到的Paint, Drawable等等都罗列在一个三千行的Theme类中，通过直接修改颜色来实现（看呆了)。都不是很理想的方法，最后可能使用前者。
3. 先给计时机器钦定了紫蓝的主题色。

## 2018年1月14日
0.0.3发布。现在可以新建计划任务了：按预定时间开启或关闭一个计时器，一次性的或者按星期几重复。

安装新版本前要写手动卸载旧版本（既然是Alpha测试，数据库结构改动就随心所欲放飞自我了）。

## 2018年1月12日
初步完成了计划任务的功能。可以像定闹钟一样设置，什么时候开启或停止一个计时器。

理想情况下，这是可以按预期工作的。但Android系统上，所有跟闹钟搭上边的应用都面临一个无法按时触发的问题。

一方面，系统为了优化电池性能而优化（推迟）闹钟触发时间。这一点可以调用在Android 6.0及以后的setExactWhileIde（似乎叫这个）来最大程度绕过，但4.4-5.1只有setExact，4.3及以前只有set了。效果当然是依次递减了。

另一方面，也是最担心也最没办法的。国内各厂商自定义的各个系统，为了应对国内众多流氓应用，会在清理应用后台时，把我设定的计划任务的闹钟也给清理掉，结果自然是没法触发。如果用户清理了最近使用的应用话，这个情况就会发生。

补充：Android O的后台限制也会极大影响能否触发。

## 2018年1月10日
Alpha 0.0.2更新了，主要加入了一些无法打开的正常开发的功能选项，也修复了很多计时器方面的问题。别的不能保证，但不删除旧版就直接安装，肯定崩溃。

## 2018年1月9日
1. 决定暂时停止对Android 5.0(API Level 21)以下的支持，兼容老版本过于浪费精力和时间。在正式版发布后再考虑兼容老版本的问题。

2. 真是谜一般的Bug，在8.1上使用Ringtone就播放无声音，非得使用MediaPlayer才可以。

## 2018年1月4日
计时器的定时开启和关闭和闹钟的设置差不多，但由于国内各厂商的设置，设置的这些闹钟不一定能唤醒。

## 2017年12月29日
由于疏忽，导致当前的测试版本在Android O(8.0, API Level 26)及以上无法创建Notification Channel，也就是会无法通知渠道。下个版本修复。

## 2017年12月26日
计划在正式版发布前加入定时启动和停止的功能。多计时器的查看功能整合在计时器列表中。

## 2017年12月18日
1. 最担心的事情发生了，Foreground Service无法准时唤醒手机，又得找黑科技解决。FML

2. 似乎用WakeLock解决了，这意味了必须用ForegroundService + WakeLock == 一直保持CPU唤醒状态 == 消耗更多的电量。

3. 不过我为什么不设计一个结合两个应用优点的应用呢，既可以使用AlarmManager省电但稍有不准，也可以使用ForegroundService + WakeLock
耗电但准时提醒？当然是能力不够啦。或许TimerMachine做的差不多后，可以在考虑添加AlramManager的实现方式。

## 2017年12月14日
|应用比较| Cycle Timer | Timer Machine |
|:---:|:---:|:---:|
|实现原理|系统闹钟(AlarmManager.setExact...)|前台服务(Foreground Service)|
|准确度|少数特定手机、少数特定情况可能失效|非常准确|
|可能的失效原因|权限、系统限制一定时间内的唤醒次数|权限、内存及其不够时服务被杀|
|可自定义内容|名称、循环、节点及其名称、是否振动、提醒音乐|名称、循环、每个节点的名称音乐振动唤醒屏幕|
|耗电|系统分配唤醒时间，影响小|需保持计时器一直运行，影响大|
|生命周期|维护尾声|正在开发|

## 2017年12月11日

提醒方式将会有音乐、振动、弹出屏幕、朗读节点名称。各自的自定义会陆续加入。

## 2017年12月10日

循环计时器+计时机器的开发日志。

之所以打算放弃维护循环计时器，重新开发新的计时机器，是因为前者是第一个正式上架的应用，用的还是MVC，代码库很乱，数据库储存格式更乱，

考虑到更多新功能的加入，决定写一个技术更前卫，使用更灵活的计时器。
